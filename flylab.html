<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlyLab - 果蝇管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #8392ff;
            --secondary: #2dce89;
            --info: #11cdef;
            --warning: #fb6340;
            --danger: #f5365c;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --hover-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4ecfb 100%);
            font-family: 'Segoe UI', 'Noto Sans SC', system-ui, sans-serif;
            min-height: 100vh;
            color: #344767;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-header {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .logo-text {
            font-weight: 700;
            font-size: 24px;
            color: var(--primary);
        }
        
        .app-nav {
            display: flex;
            gap: 15px;
        }
        
        .nav-btn {
            padding: 10px 20px;
            border-radius: 12px;
            background: white;
            border: 1px solid var(--light-gray);
            color: var(--gray);
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(94, 114, 228, 0.3);
        }
        
        .card {
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            border: none;
            margin-bottom: 25px;
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }
        
        .card-header {
            background: white;
            border-bottom: 1px solid var(--light-gray);
            padding: 20px 25px;
            font-weight: 600;
            font-size: 18px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 25px;
        }
        
        .form-section {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 0.2rem rgba(94, 114, 228, 0.25);
        }
        
        .btn-primary {
            background: var(--primary);
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background: #4a5cd4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(94, 114, 228, 0.4);
        }
        
        .btn-danger {
            background: var(--danger);
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }
        
        .btn-icon {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .batch-card {
            background: white;
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .batch-header {
            background: rgba(94, 114, 228, 0.05);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--light-gray);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .batch-header:hover {
            background: rgba(94, 114, 228, 0.1);
        }
        
        .batch-title {
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .batch-date {
            font-size: 14px;
            color: var(--gray);
            background: rgba(131, 146, 255, 0.1);
            padding: 4px 10px;
            border-radius: 20px;
        }
        
        .batch-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid var(--light-gray);
            color: var(--gray);
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tubes-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .tubes-container.expanded {
            max-height: 5000px; /* 足够大的值容纳大量管 */
        }
        
        .tube-row {
            padding: 15px 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .tube-row:last-child {
            border-bottom: none;
        }
        
        .tube-row:hover {
            background: rgba(94, 114, 228, 0.03);
        }
        
        .tube-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .tube-type {
            background: rgba(94, 114, 228, 0.1);
            color: var(--primary);
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .tube-genotype {
            font-weight: 500;
        }
        
        .tube-days {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .days-badge {
            background: rgba(45, 206, 137, 0.1);
            color: var(--secondary);
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .highlight-expansion { background-color: rgba(255, 193, 7, 0.15) !important; }
        .highlight-hybrid { background-color: rgba(255, 152, 0, 0.15) !important; }
        .highlight-lifespan-2 { background-color: rgba(3, 169, 244, 0.15) !important; }
        .highlight-lifespan-7 { background-color: rgba(33, 150, 243, 0.15) !important; }
        .highlight-negative { background-color: rgba(156, 39, 176, 0.15) !important; }
        .highlight-stock { background-color: rgba(233, 30, 99, 0.15) !important; }
        .highlight-stock-overdue { background-color: rgba(244, 67, 54, 0.15) !important; }
        
        .history-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .history-table th {
            background: rgba(94, 114, 228, 0.05);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
        }
        
        .history-table td {
            padding: 15px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .history-table tr:last-child td {
            border-bottom: none;
        }
        
        .history-table tr:hover td {
            background: rgba(94, 114, 228, 0.03);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .empty-icon {
            font-size: 60px;
            color: var(--light-gray);
            margin-bottom: 20px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(94, 114, 228, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 4px solid var(--primary);
            margin-bottom: 15px;
            transform: translateX(120%);
            transition: transform 0.3s;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: rgba(94, 114, 228, 0.1);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .toast-message {
            color: var(--gray);
            font-size: 14px;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 14px;
            box-shadow: var(--card-shadow);
        }
        
        .search-box {
            position: relative;
            width: 300px;
        }
        
        .search-box input {
            padding-left: 40px;
            border-radius: 10px;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .batch-actions-toolbar {
            display: flex;
            gap: 10px;
        }
        
        .batch-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            border: 1px solid var(--light-gray);
            cursor: pointer;
        }
        
        .batch-checkbox:checked {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .collapse-icon {
            transition: transform 0.3s;
        }
        
        .expanded .collapse-icon {
            transform: rotate(180deg);
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .app-nav {
                width: 100%;
                justify-content: center;
            }
            
            .toolbar {
                flex-direction: column;
                gap: 15px;
            }
            
            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="app-container">
        <div class="app-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-dna"></i>
                </div>
                <div class="logo-text">FlyLab</div>
            </div>
            
            <div class="app-nav">
                <button class="nav-btn active" id="addTabBtn">
                    <i class="fas fa-plus-circle"></i> 添加果蝇管
                </button>
                <button class="nav-btn" id="manageTabBtn">
                    <i class="fas fa-list"></i> 管记录管理
                </button>
                <button class="nav-btn" id="historyTabBtn">
                    <i class="fas fa-history"></i> 历史记录
                </button>
            </div>
        </div>
        
        <!-- 添加管页面 -->
        <div class="page active" id="addPage">
            <div class="card">
                <div class="card-header">
                    <span>添加新果蝇管</span>
                </div>
                <div class="card-body">
                    <form id="tubeForm">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="form-section">
                                    <label class="form-label">日期</label>
                                    <input type="date" class="form-control" id="tubeDate" required>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="form-section">
                                    <label class="form-label">管类型</label>
                                    <select class="form-select" id="tubeType" required>
                                        <option value="">选择管类型</option>
                                        <option value="expansion">扩繁管</option>
                                        <option value="hybrid">杂交管</option>
                                        <option value="virgin">处女蝇管</option>
                                        <option value="lifespan">寿命管</option>
                                        <option value="negative">负向趋地实验管</option>
                                        <option value="stock">保种管</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="form-section">
                                    <label class="form-label">管数量</label>
                                    <input type="number" class="form-control" id="tubeCount" min="1" value="1" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4" id="genotypeRow">
                            <!-- 基因型选择区域将由JS动态生成 -->
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4">
                            <button type="submit" class="btn btn-primary btn-icon">
                                <i class="fas fa-plus-circle"></i> 添加果蝇管
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 管记录管理页面 -->
        <div class="page" id="managePage">
            <div class="card">
                <div class="card-header">
                    <span>管记录管理</span>
                    <div>
                        <button class="btn btn-primary btn-icon me-2" id="exportBtn">
                            <i class="fas fa-file-excel"></i> 导出Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="toolbar">
                        <div class="d-flex align-items-center">
                            <input type="checkbox" class="batch-checkbox me-3" id="selectAllBatches">
                            <label for="selectAllBatches" class="mb-0">全选所有批次</label>
                        </div>
                        
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="form-control" placeholder="搜索批次或基因型..." id="searchInput">
                        </div>
                        
                        <div class="batch-actions-toolbar">
                            <button class="btn btn-danger btn-icon" id="deleteSelectedTubesBtn" disabled>
                                <i class="fas fa-trash"></i> 删除选中管
                            </button>
                        </div>
                    </div>
                    
                    <div id="batchesContainer">
                        <!-- 批次将由JS动态生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 历史记录页面 -->
        <div class="page" id="historyPage">
            <div class="card">
                <div class="card-header">
                    <span>历史记录（回收站）</span>
                    <div>
                        <button class="btn btn-primary btn-icon me-2" id="restoreBtn" disabled>
                            <i class="fas fa-undo"></i> 恢复选中
                        </button>
                        <button class="btn btn-danger btn-icon" id="permanentDeleteBtn" disabled>
                            <i class="fas fa-trash"></i> 删除选中
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;">
                                    <input type="checkbox" id="selectAllHistory">
                                </th>
                                <th>日期</th>
                                <th>类型</th>
                                <th>基因型</th>
                                <th>天数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- 历史记录将由JS动态生成 -->
                        </tbody>
                    </table>
                    
                    <div class="empty-state d-none" id="historyEmptyState">
                        <div class="empty-icon">
                            <i class="fas fa-inbox"></i>
                        </div>
                        <h4>回收站为空</h4>
                        <p>已删除的果蝇管将显示在这里</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初始基因型列表
        const initialGenotypes = [
            '95282', '67031', '7415', 'Da-Gal4', 
            'PLA-287', 'PLA-189', 'PLA-89', 
            'PLA-41TC', 'PLA-WT', 'PLA-97'
        ];
        
        // 获取或初始化基因型列表
        function getGenotypes() {
            const storedGenotypes = localStorage.getItem('genotypes');
            return storedGenotypes ? JSON.parse(storedGenotypes) : initialGenotypes;
        }
        
        // 保存基因型列表
        function saveGenotypes(genotypes) {
            localStorage.setItem('genotypes', JSON.stringify(genotypes));
        }
        
        // 添加新基因型
        function addGenotype(genotype) {
            const genotypes = getGenotypes();
            if (!genotypes.includes(genotype)) {
                genotypes.push(genotype);
                saveGenotypes(genotypes);
                return true;
            }
            return false;
        }
        
        // 获取或初始化批次数据
        function getBatches() {
            const storedBatches = localStorage.getItem('batches');
            return storedBatches ? JSON.parse(storedBatches) : [];
        }
        
        // 保存批次数据
        function saveBatches(batches) {
            localStorage.setItem('batches', JSON.stringify(batches));
        }
        
        // 获取或初始化历史记录
        function getHistory() {
            const storedHistory = localStorage.getItem('history');
            return storedHistory ? JSON.parse(storedHistory) : [];
        }
        
        // 保存历史记录
        function saveHistory(history) {
            localStorage.setItem('history', JSON.stringify(history));
        }
        
        // 计算天数差（今天减去添加日期）
        function calculateDays(startDate) {
            const start = new Date(startDate);
            const today = new Date();
            
            // 将时间都设置为午夜，避免时间部分影响
            start.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            
            const diffTime = today - start;
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        }
        
        // 根据管类型和天数确定高亮类
        function getHighlightClass(tubeType, days) {
            switch(tubeType) {
                case 'expansion':
                    if ([5, 7, 9].includes(days)) return 'highlight-expansion';
                    break;
                case 'hybrid':
                    if ([3, 4, 5].includes(days)) return 'highlight-hybrid';
                    break;
                case 'lifespan':
                    if (days % 7 === 0) return 'highlight-lifespan-7';
                    if (days % 2 === 0) return 'highlight-lifespan-2';
                    break;
                case 'negative':
                    if ([7, 15, 21, 30].includes(days)) return 'highlight-negative';
                    break;
                case 'stock':
                    if (days > 30) return 'highlight-stock-overdue';
                    if (days % 7 === 0) return 'highlight-stock';
                    break;
            }
            return '';
        }
        
        // 显示加载动画
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        // 隐藏加载动画
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // 显示通知
        function showToast(title, message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastEl = document.createElement('div');
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            toastEl.className = 'toast';
            toastEl.innerHTML = `
                <div class="toast-icon">
                    <i class="fas fa-${icons[type] || 'info-circle'}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            toastContainer.appendChild(toastEl);
            
            // 显示toast
            setTimeout(() => {
                toastEl.classList.add('show');
            }, 10);
            
            // 自动移除
            setTimeout(() => {
                toastEl.classList.remove('show');
                setTimeout(() => {
                    toastContainer.removeChild(toastEl);
                }, 300);
            }, 5000);
        }
        
        // 渲染基因型选择区域
        function renderGenotypeInputs() {
            const tubeType = document.getElementById('tubeType').value;
            const container = document.getElementById('genotypeRow');
            container.innerHTML = '';
            
            const genotypes = getGenotypes();
            
            // 创建第一个基因型输入
            const col1 = document.createElement('div');
            col1.className = 'col-md-6';
            
            const label1 = document.createElement('label');
            label1.className = 'form-label';
            label1.textContent = '基因型 1';
            
            const select1 = document.createElement('select');
            select1.className = 'form-select mb-2';
            select1.id = 'genotype1';
            select1.required = true;
            
            // 添加选项
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '选择基因型';
            select1.appendChild(defaultOption);
            
            genotypes.forEach(genotype => {
                const option = document.createElement('option');
                option.value = genotype;
                option.textContent = genotype;
                select1.appendChild(option);
            });
            
            // 添加手动输入选项
            const manualOption = document.createElement('option');
            manualOption.value = 'manual';
            manualOption.textContent = '手动输入...';
            select1.appendChild(manualOption);
            
            // 手动输入框
            const manualInput1 = document.createElement('input');
            manualInput1.type = 'text';
            manualInput1.className = 'form-control d-none mt-2';
            manualInput1.id = 'manualGenotype1';
            manualInput1.placeholder = '输入新基因型';
            
            col1.appendChild(label1);
            col1.appendChild(select1);
            col1.appendChild(manualInput1);
            container.appendChild(col1);
            
            // 为第一个选择框添加事件监听
            select1.addEventListener('change', function() {
                if (this.value === 'manual') {
                    manualInput1.classList.remove('d-none');
                    manualInput1.required = true;
                } else {
                    manualInput1.classList.add('d-none');
                    manualInput1.required = false;
                }
            });
            
            // 如果需要第二个基因型
            if (['hybrid', 'lifespan', 'negative'].includes(tubeType)) {
                const col2 = document.createElement('div');
                col2.className = 'col-md-6';
                
                const label2 = document.createElement('label');
                label2.className = 'form-label';
                label2.textContent = '基因型 2';
                
                const select2 = document.createElement('select');
                select2.className = 'form-select mb-2';
                select2.id = 'genotype2';
                select2.required = true;
                
                // 添加选项
                const defaultOption2 = document.createElement('option');
                defaultOption2.value = '';
                defaultOption2.textContent = '选择基因型';
                select2.appendChild(defaultOption2);
                
                genotypes.forEach(genotype => {
                    const option = document.createElement('option');
                    option.value = genotype;
                    option.textContent = genotype;
                    select2.appendChild(option);
                });
                
                // 添加手动输入选项
                const manualOption2 = document.createElement('option');
                manualOption2.value = 'manual';
                manualOption2.textContent = '手动输入...';
                select2.appendChild(manualOption2);
                
                // 手动输入框
                const manualInput2 = document.createElement('input');
                manualInput2.type = 'text';
                manualInput2.className = 'form-control d-none mt-2';
                manualInput2.id = 'manualGenotype2';
                manualInput2.placeholder = '输入新基因型';
                
                col2.appendChild(label2);
                col2.appendChild(select2);
                col2.appendChild(manualInput2);
                container.appendChild(col2);
                
                // 为第二个选择框添加事件监听
                select2.addEventListener('change', function() {
                    if (this.value === 'manual') {
                        manualInput2.classList.remove('d-none');
                        manualInput2.required = true;
                    } else {
                        manualInput2.classList.add('d-none');
                        manualInput2.required = false;
                    }
                });
            }
        }
        
        // 获取类型名称
        function getTypeName(type) {
            const typeNames = {
                'expansion': '扩繁管',
                'hybrid': '杂交管',
                'virgin': '处女蝇管',
                'lifespan': '寿命管',
                'negative': '负向趋地实验管',
                'stock': '保种管'
            };
            return typeNames[type] || type;
        }
        
        // 格式化基因型显示
        function formatGenotype(tube) {
            if (tube.genotype2) {
                return `${tube.genotype1} × ${tube.genotype2}`;
            }
            return tube.genotype1;
        }
        
        // 添加新管
        function addTube(event) {
            event.preventDefault();
            
            showLoading();
            
            setTimeout(() => {
                try {
                    const tubeDate = document.getElementById('tubeDate').value;
                    const tubeType = document.getElementById('tubeType').value;
                    const tubeCount = parseInt(document.getElementById('tubeCount').value);
                    
                    // 获取基因型1
                    let genotype1 = document.getElementById('genotype1').value;
                    if (genotype1 === 'manual') {
                        genotype1 = document.getElementById('manualGenotype1').value.trim();
                        if (genotype1) {
                            const added = addGenotype(genotype1);
                            if (added) {
                                showToast('新基因型添加', `已添加新基因型: ${genotype1}`, 'success');
                            }
                        }
                    }
                    
                    // 获取基因型2（如果需要）
                    let genotype2 = '';
                    if (['hybrid', 'lifespan', 'negative'].includes(tubeType)) {
                        genotype2 = document.getElementById('genotype2').value;
                        if (genotype2 === 'manual') {
                            genotype2 = document.getElementById('manualGenotype2').value.trim();
                            if (genotype2) {
                                const added = addGenotype(genotype2);
                                if (added) {
                                    showToast('新基因型添加', `已添加新基因型: ${genotype2}`, 'success');
                                }
                            }
                        }
                    }
                    
                    // 验证输入
                    if (!tubeDate || !tubeType || !genotype1) {
                        hideLoading();
                        showToast('表单验证失败', '请填写所有必填字段', 'error');
                        return;
                    }
                    
                    // 获取批次数据
                    const batches = getBatches();
                    
                    // 查找或创建批次
                    let batch = batches.find(b => b.date === tubeDate);
                    if (!batch) {
                        batch = {
                            id: Date.now().toString(),
                            date: tubeDate,
                            tubes: [],
                            expanded: true // 新批次默认展开
                        };
                        batches.push(batch);
                    }
                    
                    // 添加管（根据数量添加多个）
                    for (let i = 0; i < tubeCount; i++) {
                        batch.tubes.push({
                            id: Date.now().toString() + i,
                            date: tubeDate,
                            type: tubeType,
                            genotype1: genotype1,
                            genotype2: genotype2 || null
                        });
                    }
                    
                    // 保存数据
                    saveBatches(batches);
                    
                    // 重置表单
                    document.getElementById('tubeForm').reset();
                    document.getElementById('tubeDate').valueAsDate = new Date();
                    renderGenotypeInputs();
                    
                    // 显示成功消息
                    showToast('添加成功', `已成功添加 ${tubeCount} 个果蝇管`, 'success');
                    
                    // 刷新批次显示
                    if (document.getElementById('managePage').classList.contains('active')) {
                        renderBatches();
                    }
                } catch (error) {
                    console.error('添加果蝇管时出错:', error);
                    showToast('添加失败', '请检查输入后重试', 'error');
                } finally {
                    hideLoading();
                }
            }, 300);
        }
        
        // 渲染批次和管记录
        function renderBatches() {
            showLoading();
            
            setTimeout(() => {
                try {
                    const batches = getBatches();
                    const container = document.getElementById('batchesContainer');
                    container.innerHTML = '';
                    
                    if (batches.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-vial"></i>
                                </div>
                                <h4>暂无果蝇管记录</h4>
                                <p>请添加新的果蝇管以开始管理</p>
                            </div>
                        `;
                        hideLoading();
                        return;
                    }
                    
                    // 搜索功能
                    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                    
                    batches.forEach(batch => {
                        // 检查批次是否匹配搜索词
                        const batchMatches = batch.date.toLowerCase().includes(searchTerm);
                        
                        // 过滤批次中的管
                        const filteredTubes = batch.tubes.filter(tube => {
                            return (
                                batchMatches || 
                                formatGenotype(tube).toLowerCase().includes(searchTerm) || 
                                getTypeName(tube.type).toLowerCase().includes(searchTerm)
                            );
                        });
                        
                        if (filteredTubes.length === 0) return;
                        
                        const batchElement = document.createElement('div');
                        batchElement.className = 'batch-card';
                        
                        const batchHeader = document.createElement('div');
                        batchHeader.className = `batch-header ${batch.expanded ? 'expanded' : ''}`;
                        batchHeader.setAttribute('data-batch-id', batch.id);
                        batchHeader.innerHTML = `
                            <div class="batch-title">
                                <i class="fas fa-chevron-down collapse-icon"></i>
                                <span>批次: ${batch.date}</span>
                                <span class="batch-date">${filteredTubes.length}个管</span>
                            </div>
                            <div class="batch-actions">
                                <button class="action-btn delete-batch" data-batch-id="${batch.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        
                        const tubesContainer = document.createElement('div');
                        tubesContainer.className = `tubes-container ${batch.expanded ? 'expanded' : ''}`;
                        
                        filteredTubes.forEach(tube => {
                            const days = calculateDays(tube.date);
                            const highlightClass = getHighlightClass(tube.type, days);
                            
                            const tubeElement = document.createElement('div');
                            tubeElement.className = `tube-row ${highlightClass}`;
                            tubeElement.innerHTML = `
                                <div class="tube-info">
                                    <input type="checkbox" class="batch-checkbox tube-checkbox" data-batch-id="${batch.id}" data-tube-id="${tube.id}">
                                    <span class="tube-type">${getTypeName(tube.type)}</span>
                                    <span class="tube-genotype">${formatGenotype(tube)}</span>
                                </div>
                                <div class="tube-days">
                                    <span class="days-badge">${days}天</span>
                                    <button class="action-btn delete-tube" data-batch-id="${batch.id}" data-tube-id="${tube.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                            tubesContainer.appendChild(tubeElement);
                        });
                        
                        batchElement.appendChild(batchHeader);
                        batchElement.appendChild(tubesContainer);
                        container.appendChild(batchElement);
                    });
                    
                    // 设置复选框状态
                    updateDeleteButtonState();
                    
                    hideLoading();
                } catch (error) {
                    console.error('渲染批次时出错:', error);
                    hideLoading();
                }
            }, 300);
        }
        
        // 渲染历史记录
        function renderHistory() {
            showLoading();
            
            setTimeout(() => {
                try {
                    const history = getHistory();
                    const container = document.getElementById('historyTableBody');
                    const emptyState = document.getElementById('historyEmptyState');
                    container.innerHTML = '';
                    
                    if (history.length === 0) {
                        emptyState.classList.remove('d-none');
                        hideLoading();
                        return;
                    }
                    
                    emptyState.classList.add('d-none');
                    
                    // 只显示最近的50条历史记录
                    const recentHistory = history.slice(-50);
                    
                    recentHistory.forEach((record) => {
                        const days = calculateDays(record.date);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <input type="checkbox" class="history-checkbox" data-id="${record.id}">
                            </td>
                            <td>${record.date}</td>
                            <td><span class="tube-type">${getTypeName(record.type)}</span></td>
                            <td>${formatGenotype(record)}</td>
                            <td>${days}天</td>
                            <td>
                                <button class="action-btn restore-btn" data-id="${record.id}">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button class="action-btn delete-btn" data-id="${record.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        container.appendChild(row);
                    });
                    
                    hideLoading();
                } catch (error) {
                    console.error('渲染历史记录时出错:', error);
                    hideLoading();
                }
            }, 300);
        }
        
        // 删除批次
        function deleteBatch(batchId) {
            if (!confirm('确定要删除整个批次吗？此操作会将批次中的所有管移到回收站。')) return;
            
            showLoading();
            
            setTimeout(() => {
                try {
                    const batches = getBatches();
                    const history = getHistory();
                    
                    const batchIndex = batches.findIndex(b => b.id === batchId);
                    if (batchIndex !== -1) {
                        // 将批次中的所有管移到历史记录
                        history.push(...batches[batchIndex].tubes);
                        
                        // 删除批次
                        batches.splice(batchIndex, 1);
                        
                        // 保存数据
                        saveBatches(batches);
                        saveHistory(history);
                        
                        // 刷新显示
                        renderBatches();
                        renderHistory();
                        
                        showToast('批次已删除', '批次已移至历史记录', 'success');
                    }
                } catch (error) {
                    console.error('删除批次时出错:', error);
                    showToast('删除失败', '请重试', 'error');
                } finally {
                    hideLoading();
                }
            }, 300);
        }
        
        // 删除管
        function deleteTube(batchId, tubeId) {
            if (!confirm('确定要删除此果蝇管吗？此操作会将管移到回收站。')) return;
            
            showLoading();
            
            setTimeout(() => {
                try {
                    const batches = getBatches();
                    const history = getHistory();
                    
                    const batchIndex = batches.findIndex(b => b.id === batchId);
                    if (batchIndex !== -1) {
                        const batch = batches[batchIndex];
                        const tubeIndex = batch.tubes.findIndex(t => t.id === tubeId);
                        
                        if (tubeIndex !== -1) {
                            // 将管移到历史记录
                            history.push(batch.tubes[tubeIndex]);
                            
                            // 从批次中删除管
                            batch.tubes.splice(tubeIndex, 1);
                            
                            // 如果批次中没有管了，删除批次
                            if (batch.tubes.length === 0) {
                                batches.splice(batchIndex, 1);
                            }
                            
                            // 保存数据
                            saveBatches(batches);
                            saveHistory(history);
                            
                            // 刷新显示
                            renderBatches();
                            renderHistory();
                            
                            showToast('果蝇管已删除', '已移至历史记录', 'success');
                        }
                    }
                } catch (error) {
                    console.error('删除果蝇管时出错:', error);
                    showToast('删除失败', '请重试', 'error');
                } finally {
                    hideLoading();
                }
            }, 300);
        }
        
        // 从历史记录恢复
        function restoreFromHistory(id) {
            showLoading();
            
            setTimeout(() => {
                try {
                    const history = getHistory();
                    const batches = getBatches();
                    
                    const historyIndex = history.findIndex(item => item.id === id);
                    if (historyIndex !== -1) {
                        const tube = history[historyIndex];
                        
                        // 查找或创建批次
                        let batch = batches.find(b => b.date === tube.date);
                        if (!batch) {
                            batch = {
                                id: Date.now().toString(),
                                date: tube.date,
                                tubes: [],
                                expanded: true
                            };
                            batches.push(batch);
                        }
                        
                        // 添加到批次
                        batch.tubes.push(tube);
                        
                        // 从历史记录中删除
                        history.splice(historyIndex, 1);
                        
                        // 保存数据
                        saveBatches(batches);
                        saveHistory(history);
                        
                        // 刷新显示
                        renderBatches();
                        renderHistory();
                        
                        showToast('恢复成功', '果蝇管已恢复', 'success');
                    }
                } catch (error) {
                    console.error('恢复果蝇管时出错:', error);
                    showToast('恢复失败', '请重试', 'error');
                } finally {
                    hideLoading();
                }
            }, 300);
        }
        
        // 从历史记录永久删除
        function deleteFromHistory(id) {
            if (!confirm('确定要永久删除此记录吗？此操作不可撤销。')) return;
            
            showLoading();
            
            setTimeout(() => {
                try {
                    const history = getHistory();
                    
                    const historyIndex = history.findIndex(item => item.id === id);
                    if (historyIndex !== -1) {
                        history.splice(historyIndex, 1);
                        saveHistory(history);
                        renderHistory();
                        
                        showToast('永久删除', '记录已删除', 'success');
                    }
                } catch (error) {
                    console.error('永久删除记录时出错:', error);
                    showToast('删除失败', '请重试', 'error');
                } finally {
                    hideLoading();
                }
            }, 300);
        }
        
        // 设置复选框状态
        function updateDeleteButtonState() {
            const anyChecked = document.querySelectorAll('.tube-checkbox:checked').length > 0;
            document.getElementById('deleteSelectedTubesBtn').disabled = !anyChecked;
            
            const anyHistoryChecked = document.querySelectorAll('.history-checkbox:checked').length > 0;
            document.getElementById('restoreBtn').disabled = !anyHistoryChecked;
            document.getElementById('permanentDeleteBtn').disabled = !anyHistoryChecked;
        }
        
        // 导出Excel
        function exportToExcel() {
            showLoading();
            
            setTimeout(() => {
                try {
                    const batches = getBatches();
                    if (batches.length === 0) {
                        hideLoading();
                        showToast('导出失败', '没有可导出的数据', 'warning');
                        return;
                    }
                    
                    const workbook = XLSX.utils.book_new();
                    
                    batches.forEach(batch => {
                        const worksheetData = [
                            ['日期', '类型', '基因型', '天数']
                        ];
                        
                        batch.tubes.forEach(tube => {
                            const days = calculateDays(tube.date);
                            worksheetData.push([
                                tube.date,
                                getTypeName(tube.type),
                                formatGenotype(tube),
                                days
                            ]);
                        });
                        
                        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                        XLSX.utils.book_append_sheet(workbook, worksheet, batch.date);
                    });
                    
                    XLSX.writeFile(workbook, '果蝇管理记录.xlsx');
                    showToast('导出成功', 'Excel文件已生成', 'success');
                } catch (error) {
                    console.error('导出Excel时出错:', error);
                    showToast('导出失败', '请重试', 'error');
                } finally {
                    hideLoading();
                }
            }, 500);
        }
        
        // 切换批次展开状态
        function toggleBatchExpansion(batchId) {
            const batches = getBatches();
            const batchIndex = batches.findIndex(b => b.id === batchId);
            
            if (batchIndex !== -1) {
                batches[batchIndex].expanded = !batches[batchIndex].expanded;
                saveBatches(batches);
                renderBatches();
            }
        }
        
        // 切换页面
        function switchPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示目标页面
            document.getElementById(pageId).classList.add('active');
            
            // 更新导航按钮状态
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 激活当前页面对应的按钮
            if (pageId === 'addPage') {
                document.getElementById('addTabBtn').classList.add('active');
            } else if (pageId === 'managePage') {
                document.getElementById('manageTabBtn').classList.add('active');
                renderBatches();
            } else if (pageId === 'historyPage') {
                document.getElementById('historyTabBtn').classList.add('active');
                renderHistory();
            }
        }
        
        // 批量删除选中的管
        function deleteSelectedTubes() {
            const selectedTubes = document.querySelectorAll('.tube-checkbox:checked');
            if (selectedTubes.length === 0) {
                showToast('操作提示', '请先选择要删除的果蝇管', 'info');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${selectedTubes.length} 个果蝇管吗？此操作会将管移到回收站。`)) return;
            
            showLoading();
            
            setTimeout(() => {
                try {
                    const batches = getBatches();
                    const history = getHistory();
                    let updated = false;
                    
                    selectedTubes.forEach(checkbox => {
                        const batchId = checkbox.getAttribute('data-batch-id');
                        const tubeId = checkbox.getAttribute('data-tube-id');
                        
                        const batchIndex = batches.findIndex(b => b.id === batchId);
                        if (batchIndex !== -1) {
                            const batch = batches[batchIndex];
                            const tubeIndex = batch.tubes.findIndex(t => t.id === tubeId);
                            
                            if (tubeIndex !== -1) {
                                // 将管移到历史记录
                                history.push(batch.tubes[tubeIndex]);
                                
                                // 从批次中删除管
                                batch.tubes.splice(tubeIndex, 1);
                                updated = true;
                                
                                // 如果批次中没有管了，删除批次
                                if (batch.tubes.length === 0) {
                                    batches.splice(batchIndex, 1);
                                }
                            }
                        }
                    });
                    
                    if (updated) {
                        // 保存数据
                        saveBatches(batches);
                        saveHistory(history);
                        
                        // 刷新显示
                        renderBatches();
                        renderHistory();
                        
                        showToast('批量删除', `${selectedTubes.length}个果蝇管已移至历史记录`, 'success');
                    }
                } catch (error) {
                    console.error('批量删除时出错:', error);
                    showToast('删除失败', '请重试', 'error');
                } finally {
                    hideLoading();
                }
            }, 300);
        }
        
        // 批量删除历史记录
        function batchDeleteHistory() {
            const checkboxes = document.querySelectorAll('.history-checkbox:checked');
            if (checkboxes.length === 0) {
                showToast('操作提示', '请选择要删除的历史记录', 'info');
                return;
            }
            
            if (!confirm(`确定要永久删除选中的 ${checkboxes.length} 条历史记录吗？此操作不可撤销。`)) return;
            
            showLoading();
            
            setTimeout(() => {
                try {
                    const history = getHistory();
                    const idsToDelete = Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-id'));
                    
                    // 过滤掉选中的记录
                    const newHistory = history.filter(record => !idsToDelete.includes(record.id));
                    
                    saveHistory(newHistory);
                    renderHistory();
                    
                    showToast('批量删除', `${checkboxes.length}条历史记录已永久删除`, 'success');
                } catch (error) {
                    console.error('批量删除历史记录时出错:', error);
                    showToast('删除失败', '请重试', 'error');
                } finally {
                    hideLoading();
                }
            }, 300);
        }
        
        // 批量恢复历史记录
        function batchRestoreHistory() {
            const checkboxes = document.querySelectorAll('.history-checkbox:checked');
            if (checkboxes.length === 0) {
                showToast('操作提示', '请选择要恢复的历史记录', 'info');
                return;
            }
            
            showLoading();
            
            setTimeout(() => {
                try {
                    checkboxes.forEach(checkbox => {
                        const id = checkbox.getAttribute('data-id');
                        restoreFromHistory(id);
                    });
                } finally {
                    hideLoading();
                }
            }, 300);
        }
        
        // 初始化页面
        function initPage() {
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tubeDate').value = today;
            
            // 渲染基因型输入
            renderGenotypeInputs();
            
            // 添加管类型变更事件
            document.getElementById('tubeType').addEventListener('change', renderGenotypeInputs);
            
            // 添加表单提交事件
            document.getElementById('tubeForm').addEventListener('submit', addTube);
            
            // 添加导出按钮事件
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            
            // 添加导航按钮事件
            document.getElementById('addTabBtn').addEventListener('click', function() {
                switchPage('addPage');
            });
            
            document.getElementById('manageTabBtn').addEventListener('click', function() {
                switchPage('managePage');
            });
            
            document.getElementById('historyTabBtn').addEventListener('click', function() {
                switchPage('historyPage');
            });
            
            // 添加批量删除按钮事件
            document.getElementById('deleteSelectedTubesBtn').addEventListener('click', deleteSelectedTubes);
            
            // 添加历史记录恢复和删除事件
            document.getElementById('restoreBtn').addEventListener('click', batchRestoreHistory);
            document.getElementById('permanentDeleteBtn').addEventListener('click', batchDeleteHistory);
            
            // 使用事件委托处理删除操作
            document.getElementById('batchesContainer').addEventListener('click', function(event) {
                if (event.target.closest('.delete-batch')) {
                    const batchId = event.target.closest('.delete-batch').getAttribute('data-batch-id');
                    deleteBatch(batchId);
                    return;
                }
                
                if (event.target.closest('.delete-tube')) {
                    const btn = event.target.closest('.delete-tube');
                    const batchId = btn.getAttribute('data-batch-id');
                    const tubeId = btn.getAttribute('data-tube-id');
                    deleteTube(batchId, tubeId);
                }
                
                // 处理批次展开/折叠
                if (event.target.closest('.batch-header')) {
                    const batchId = event.target.closest('.batch-header').getAttribute('data-batch-id');
                    toggleBatchExpansion(batchId);
                }
                
                // 处理管复选框状态变化
                if (event.target.matches('.tube-checkbox')) {
                    updateDeleteButtonState();
                }
            });
            
            document.getElementById('historyTableBody').addEventListener('click', function(event) {
                if (event.target.closest('.restore-btn')) {
                    const btn = event.target.closest('.restore-btn');
                    const id = btn.getAttribute('data-id');
                    restoreFromHistory(id);
                    return;
                }
                
                if (event.target.closest('.delete-btn')) {
                    const btn = event.target.closest('.delete-btn');
                    const id = btn.getAttribute('data-id');
                    deleteFromHistory(id);
                }
                
                // 处理历史记录复选框状态变化
                if (event.target.matches('.history-checkbox')) {
                    updateDeleteButtonState();
                }
            });
            
            // 设置复选框状态事件
            document.getElementById('selectAllBatches').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.tube-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateDeleteButtonState();
            });
            
            document.getElementById('selectAllHistory').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.history-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateDeleteButtonState();
            });
            
            // 添加搜索功能
            document.getElementById('searchInput').addEventListener('input', renderBatches);
            
            // 初始页面设置
            switchPage('addPage');
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>